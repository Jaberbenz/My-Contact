# Guide de Tests - Contact App

Ce document d√©crit la suite de tests compl√®te pour l'application Contact App.

## üìã Vue d'ensemble

Le projet dispose d'une couverture de tests compl√®te pour le backend et le frontend :

### Backend (Server)

- ‚úÖ Tests unitaires des services (authService)
- ‚úÖ Tests unitaires des models (User, Contact)
- ‚úÖ Tests d'int√©gration des middlewares (auth)
- ‚úÖ Tests d'int√©gration des routes API (auth, contacts)
- ‚úÖ Framework: Jest avec Supertest et MongoDB Memory Server

### Frontend (Client)

- ‚úÖ Tests unitaires des composants React (Login, Register, ContactForm, ContactList, App)
- ‚úÖ Tests du contexte (AuthContext)
- ‚úÖ Tests de l'API client
- ‚úÖ Framework: Jest avec React Testing Library

## üöÄ Installation des d√©pendances

### Backend

```bash
cd server
npm install
```

D√©pendances de test install√©es :

- `jest` - Framework de test
- `supertest` - Tests HTTP
- `mongodb-memory-server` - Base de donn√©es en m√©moire pour les tests
- `cross-env` - Variables d'environnement cross-platform

### Frontend

```bash
cd client
npm install
```

D√©pendances de test (d√©j√† incluses) :

- `@testing-library/react` - Tests de composants React
- `@testing-library/jest-dom` - Matchers personnalis√©s
- `@testing-library/user-event` - Simulation d'interactions utilisateur

## üß™ Ex√©cution des tests

### Tests Backend

```bash
cd server

# Ex√©cuter tous les tests
npm test

# Ex√©cuter les tests en mode watch
npm run test:watch

# Ex√©cuter les tests avec couverture de code
npm run test:coverage
```

### Tests Frontend

```bash
cd client

# Ex√©cuter tous les tests
npm test

# Ex√©cuter les tests en mode watch (d√©j√† par d√©faut)
npm test

# Ex√©cuter les tests avec couverture de code
npm test -- --coverage --watchAll=false
```

## üìÅ Structure des tests

### Backend (`server/tests/`)

```
server/tests/
‚îú‚îÄ‚îÄ setup.js                          # Configuration globale
‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îî‚îÄ‚îÄ testHelpers.js               # Fonctions utilitaires pour les tests
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ authService.test.js      # Tests du service d'authentification
‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ       ‚îú‚îÄ‚îÄ User.test.js              # Tests du mod√®le User
‚îÇ       ‚îî‚îÄ‚îÄ Contact.test.js           # Tests du mod√®le Contact
‚îî‚îÄ‚îÄ integration/
    ‚îú‚îÄ‚îÄ middleware/
    ‚îÇ   ‚îî‚îÄ‚îÄ auth.test.js              # Tests des middlewares d'auth
    ‚îî‚îÄ‚îÄ routes/
        ‚îú‚îÄ‚îÄ auth.test.js              # Tests des routes d'authentification
        ‚îî‚îÄ‚îÄ contact.test.js           # Tests des routes de contacts
```

### Frontend (`client/src/`)

```
client/src/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ client.test.js                # Tests de l'API client
‚îú‚îÄ‚îÄ context/
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.test.js          # Tests du contexte d'authentification
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ Login.test.js                # Tests du composant Login
‚îÇ   ‚îú‚îÄ‚îÄ Register.test.js             # Tests du composant Register
‚îÇ   ‚îú‚îÄ‚îÄ ContactForm.test.js          # Tests du formulaire de contact
‚îÇ   ‚îî‚îÄ‚îÄ ContactList.test.js          # Tests de la liste de contacts
‚îî‚îÄ‚îÄ App.test.js                       # Tests du composant principal
```

## üìä Couverture des tests

### Backend

Les tests couvrent :

#### Services (authService)

- ‚úÖ G√©n√©ration de tokens JWT
- ‚úÖ V√©rification de tokens
- ‚úÖ Cr√©ation d'utilisateurs avec tokens
- ‚úÖ Authentification d'utilisateurs
- ‚úÖ Gestion des erreurs

#### Models

**User:**

- ‚úÖ Validation des champs (email, password)
- ‚úÖ Hashing automatique du mot de passe
- ‚úÖ M√©thode comparePassword
- ‚úÖ M√©thode toJSON (exclusion du mot de passe)
- ‚úÖ Timestamps automatiques

**Contact:**

- ‚úÖ Validation des champs obligatoires et optionnels
- ‚úÖ Validation des formats (t√©l√©phone, email)
- ‚úÖ Trim automatique des champs
- ‚úÖ M√©thodes getFullName et fullName (virtual)
- ‚úÖ Timestamps automatiques

#### Middlewares

- ‚úÖ requireAuth : authentification obligatoire
- ‚úÖ optionalAuth : authentification optionnelle
- ‚úÖ Gestion des tokens invalides/expir√©s
- ‚úÖ Gestion des utilisateurs supprim√©s

#### Routes API

**Auth:**

- ‚úÖ POST /auth/register - Inscription
- ‚úÖ POST /auth/login - Connexion
- ‚úÖ GET /auth/profile - Profil utilisateur
- ‚úÖ GET /auth/verify - V√©rification du token

**Contacts:**

- ‚úÖ POST /contacts - Cr√©er un contact
- ‚úÖ GET /contacts - Lister les contacts (avec pagination, tri, recherche)
- ‚úÖ GET /contacts/:id - Obtenir un contact
- ‚úÖ PATCH /contacts/:id - Mettre √† jour un contact
- ‚úÖ DELETE /contacts/:id - Supprimer un contact
- ‚úÖ DELETE /contacts - Supprimer tous les contacts
- ‚úÖ Isolation des donn√©es par utilisateur

### Frontend

Les tests couvrent :

#### API Client

- ‚úÖ Requ√™tes HTTP (GET, POST, PATCH, DELETE)
- ‚úÖ Gestion des tokens d'authentification
- ‚úÖ Gestion des erreurs HTTP
- ‚úÖ D√©connexion automatique sur 401
- ‚úÖ Gestion des erreurs r√©seau

#### AuthContext

- ‚úÖ Hook useAuth
- ‚úÖ √âtat initial et chargement depuis localStorage
- ‚úÖ Fonction register
- ‚úÖ Fonction login (avec chargement des contacts)
- ‚úÖ Fonction logout
- ‚úÖ Fonctions CRUD contacts (create, update, delete, load)
- ‚úÖ Gestion des erreurs

#### Composants

**Login:**

- ‚úÖ Rendu du formulaire
- ‚úÖ Validation de l'email
- ‚úÖ Validation du mot de passe
- ‚úÖ Soumission du formulaire
- ‚úÖ Affichage des erreurs
- ‚úÖ Navigation vers l'inscription

**Register:**

- ‚úÖ Rendu du formulaire
- ‚úÖ Validation de l'email
- ‚úÖ Validation de la complexit√© du mot de passe
- ‚úÖ Indicateur de force du mot de passe
- ‚úÖ V√©rification de correspondance des mots de passe
- ‚úÖ Soumission et alerte de succ√®s
- ‚úÖ Navigation vers la connexion

**ContactForm:**

- ‚úÖ Mode ajout et modification
- ‚úÖ Validation de tous les champs
- ‚úÖ Compteur de caract√®res pour l'adresse
- ‚úÖ Cr√©ation de contact
- ‚úÖ Mise √† jour de contact
- ‚úÖ Annulation
- ‚úÖ Affichage des erreurs

**ContactList:**

- ‚úÖ Affichage de l'utilisateur connect√©
- ‚úÖ D√©connexion
- ‚úÖ √âtat vide
- ‚úÖ Affichage de la liste
- ‚úÖ Compteur de contacts
- ‚úÖ Ouverture/fermeture du formulaire
- ‚úÖ √âdition de contact
- ‚úÖ Suppression avec confirmation

**App:**

- ‚úÖ √âtat de chargement
- ‚úÖ Affichage conditionnel (Login/Register/ContactList)
- ‚úÖ Navigation entre Login et Register
- ‚úÖ Gestion du changement d'√©tat utilisateur

## üéØ Exemples de tests

### Backend - Test unitaire

```javascript
it("devrait cr√©er un utilisateur et g√©n√©rer un token", async () => {
  const userData = {
    email: "newuser@example.com",
    password: "Password123",
  };

  const result = await createUserWithToken(userData);

  expect(result.user.email).toBe(userData.email);
  expect(result.token).toBeDefined();
  expect(result.user.password).toBeUndefined();
});
```

### Backend - Test d'int√©gration

```javascript
it("devrait cr√©er un nouveau contact avec des donn√©es valides", async () => {
  const contactData = {
    firstName: "Jean",
    lastName: "Dupont",
    phone: "+33 6 12 34 56 78",
  };

  const response = await request(app)
    .post("/contacts")
    .set("Authorization", `Bearer ${userToken}`)
    .send(contactData)
    .expect(201);

  expect(response.body.success).toBe(true);
  expect(response.body.data.contact.firstName).toBe("Jean");
});
```

### Frontend - Test de composant

```javascript
it("devrait soumettre le formulaire avec des donn√©es valides", async () => {
  mockLogin.mockResolvedValue({ success: true });

  render(<Login onSwitchToRegister={jest.fn()} />);

  await userEvent.type(
    screen.getByPlaceholderText(/email/i),
    "test@example.com"
  );
  await userEvent.type(
    screen.getByPlaceholderText(/mot de passe/i),
    "Password123"
  );
  await userEvent.click(screen.getByRole("button", { name: /Se connecter/i }));

  expect(mockLogin).toHaveBeenCalledWith("test@example.com", "Password123");
});
```

## ‚öôÔ∏è Configuration

### Backend - jest.config.js

```javascript
export default {
  testEnvironment: "node",
  transform: {},
  extensionsToTreatAsEsm: [".js"],
  testMatch: ["**/tests/**/*.test.js"],
  collectCoverageFrom: ["src/**/*.js", "!src/config/**"],
  coverageDirectory: "coverage",
  testTimeout: 10000,
  verbose: true,
};
```

### Frontend - setupTests.js

Le fichier de configuration existe d√©j√† dans `client/src/setupTests.js` et importe `@testing-library/jest-dom` pour les matchers personnalis√©s.

## üîç Bonnes pratiques

### Tests Backend

1. **Isolation** : Chaque test est isol√© avec `beforeEach/afterEach`
2. **Base de donn√©es** : Utilisation de MongoDB Memory Server pour des tests rapides
3. **Helpers** : Fonctions r√©utilisables dans `testHelpers.js`
4. **Nommage** : Descriptions claires en fran√ßais
5. **AAA Pattern** : Arrange, Act, Assert

### Tests Frontend

1. **Mocking** : Mock des d√©pendances externes (AuthContext, API)
2. **User Events** : Utilisation de `@testing-library/user-event` pour simuler les interactions
3. **Queries** : Pr√©f√©rence pour les queries accessibles (getByRole, getByLabelText)
4. **waitFor** : Gestion des op√©rations asynchrones
5. **Test d'int√©gration** : Tests de flux complets utilisateur

## üìà CI/CD

Pour int√©grer les tests dans un pipeline CI/CD :

```yaml
# Exemple pour GitHub Actions
- name: Test Backend
  run: |
    cd server
    npm ci
    npm test -- --coverage

- name: Test Frontend
  run: |
    cd client
    npm ci
    npm test -- --coverage --watchAll=false
```

## üêõ D√©bogage

### Backend

Pour d√©boguer un test sp√©cifique :

```bash
cd server
npm test -- authService.test.js
```

### Frontend

Pour d√©boguer un test sp√©cifique :

```bash
cd client
npm test -- Login.test.js
```

### Mode Verbose

Les deux configurations utilisent `verbose: true` pour des logs d√©taill√©s.

## üìù Notes importantes

- Les tests backend utilisent une base de donn√©es en m√©moire, aucune configuration MongoDB externe n'est n√©cessaire
- Les tests frontend mockent les appels API, aucun serveur backend n'est n√©cessaire
- Tous les tests peuvent √™tre ex√©cut√©s en parall√®le (`--runInBand` pour le backend pour √©viter les conflits DB)
- La couverture de code est g√©n√©r√©e dans le dossier `coverage/`

## üéâ R√©sum√©

- **Backend** : 80+ tests couvrant tous les services, models, middlewares et routes
- **Frontend** : 70+ tests couvrant tous les composants, contextes et utilitaires
- **Couverture** : > 90% du code m√©tier
- **Ex√©cution** : ~10-15 secondes pour la suite compl√®te

Tous les tests sont pr√™ts √† √™tre ex√©cut√©s et peuvent √™tre int√©gr√©s dans un pipeline CI/CD.
